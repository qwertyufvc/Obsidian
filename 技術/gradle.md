
# `gradle build`

`gradle build` コマンドを実行すると、Gradle はビルドパイプラインに沿って一連のタスクを順番に実行します。具体的には、以下のようなプロセスが裏側で行われます。

---

### **1. Gradle ビルドスクリプトの読み込み**

まず、Gradle は `build.gradle` または Kotlin DSL (`build.gradle.kts`) を解析します。

- プロジェクト情報 (`group`, `version`, `sourceCompatibility` など) を読み取ります。
- 使用するプラグイン（例えば `java`, `spring-boot`）や依存関係（`dependencies` セクションの内容）を取得します。
- 必要なタスクや設定情報を構築します。

---

### **2. Gradle の設定フェーズ**

次に、プロジェクトに適用される全ての設定やタスクが準備されます。

#### **やること**

- ディレクトリ構造の確認（`src/main/java`、`src/test/java` など）。
- プラグインやフレームワークが提供するデフォルトのタスク（例：`compileJava`, `processResources`）のセットアップ。
- 依存関係の解析（`dependencies` に基づいて必要なライブラリを Gradle がダウンロードする）。
- 必要ならキャッシュの確認（以前のビルド情報を利用可能か確認）。

---

### **3. 実行フェーズ – 各タスクの実行**

`build` タスク自体は **複数のタスクを組み合わせたタスク** です。それらのタスクが適切な順序で実行されます。

主なタスク（`java` プラグインを使用している場合）とその順序は以下の通りです：

---

#### **(1) `clean` （オプション）**

- **目的**: 古いビルド成果物（例：`build/` ディレクトリ内のファイル）を削除。
- **実行内容**:
    - 出力ファイル、キャッシュファイルを削除し、クリーンな状態から始めます。

---

#### **(2) `compileJava`**

- **目的**: Java ソースコード（`src/main/java`）をコンパイル。
- **実行内容**:
    - `javac` を使ってソースファイルをコンパイル。
    - コンパイルされた `class` ファイルは `build/classes/java/main` ディレクトリに出力されます。

**失敗する場合の事例**:

- コンパイルエラー（例：シンタックスエラー、依存関係のミス）。
- 必要な依存ライブラリが見つからない場合（`class not found`）。

---

#### **(3) `processResources`**

- **目的**: リソースファイル（例：`src/main/resources` 下のファイル）を処理。
- **実行内容**:
    - リソース（`.properties`, `.xml`, `.json`, `.yml` など）を `build/resources/main` ディレクトリにコピー。
    - プレースホルダ（`${variable}` のような値）を必要に応じて置換。

---

#### **(4) `classes`**

- **目的**: `compileJava` と `processResources` の依存タスク。
- すべての `.class` ファイルやリソースが揃うようにします。

---

#### **(5) `test`**

- **目的**: 単体テストの実行。
- **実行内容**:
    - テストコード（`src/test/java`）をコンパイル: `compileTestJava`。
    - テスト用リソース（`src/test/resources`）を処理: `processTestResources`。
    - テストを実行:
        - 単体テストフレームワーク（例：JUnit, TestNG）を実行。
        - テスト結果（成功/失敗レポート）が `build/test-results` または `build/reports/tests` に出力。

---

#### **(6) `jar` または `bootJar`**

- **目的**: Java アプリケーションをパッケージング。
- **実行内容**:
    - `jar` タスク: アプリケーションのバイトコードやリソースを `.jar` ファイルにまとめる。
    - `bootJar`（Spring Boot プラグインの場合）: 実行可能な Spring Boot アプリケーションの `.jar` ファイルを構築。

出力ファイルは通常 `build/libs` に保存されます。

---

#### **(7) `assemble`**

- **目的**: アプリケーションの成果物を構築（`jar` や `bootJar` タスクの依存タスク）。
- **実行内容**:
    - `jar` や `bootJar` などのタスクを実行し、成果物が生成されたことを確認。

---

#### **(8) `check`**

- **目的**: コード品質や動作確認。
- **実行内容**（プロジェクトに応じて異なる）:
    - Lint チェック（静的解析ツール）。
    - テスト（単体テスト、統合テストなど）。

---

#### **(9) `build`**

- **目的**: すべてのタスクを順番にまとめて実行。
- **実行内容**:
    - 上記で説明したすべてのタスク（例：`clean`, `classes`, `test`, `jar`, `assemble`）を順番に実行。

---

### **4. 成果物の生成**

最後にビルドが成功すれば、成果物が生成されます。成果物の生成場所は通常以下の通りです：

- **通常の Jar**: `build/libs/{プロジェクト名}-{バージョン}.jar`
- **テスト結果**: `build/reports/tests/test/index.html`（テスト結果の HTML レポート）など。

---

### **まとめたビルドプロセスのフロー**

以下が典型的な `gradle build` 実行時の処理フローです：

1. Gradle スクリプトの読み込み・解析。
2. 必要な設定の初期化（プラグイン、依存関係、タスク）。
3. タスクの実行順序：
    - `clean`（古い成果物の削除）
    - `compileJava`（ソースコードのコンパイル）
    - `processResources`（リソースファイルの処理）
    - `classes`（ビルド対象をまとめる）
    - `test`（テスト実行）
    - `jar` または `bootJar`（パッケージング）
    - `assemble`（ビルドアーティファクトを生成）
    - `check`（コード品質や動作確認）
    - `build`（一連のタスクをすべて実行）

各ステップでエラーや警告が出た場合、ビルドはその時点で中断されます。

---

### **補足**

タスク順序や内容はプロジェクトの構成やプラグインによって変更される場合がありますが、上記の手順が一般的な流れです。もしより具体的なプロジェクトの詳細を見たい場合、`./gradlew tasks` で利用可能なすべてのタスクを確認できます。